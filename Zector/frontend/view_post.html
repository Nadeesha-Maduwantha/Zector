<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Post - Zector</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h2>Zector</h2>
            </div>
            
            <div class="nav-actions" style="margin-left: auto;">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="about.html" class="nav-link">About</a>
                <a href="contact.html" class="nav-link">Contact</a>
                <a href="create_post.html" class="nav-btn nav-btn-create">Create Post</a>
                <a href="account.html" class="user-avatar" id="userAvatar" title="My Account">
                    <img id="avatarPhoto" src="" alt="" style="display: none;">
                    <span id="avatarInitial">N</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="postContainer">
            <div class="loading">Loading post...</div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        checkAuth();
        
        // Get post ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');
        
        if (!postId) {
            window.location.href = 'dashboard.html';
        }

        let currentUserId = null;

        // Load user info for avatar
        fetch('../backend/get_posts.php')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateAvatar(data.username, data.profile_photo);
                    currentUserId = data.user_id;
                    loadPost();
                }
            });

        function updateAvatar(username, profilePhoto) {
            const initial = username.charAt(0).toUpperCase();
            const avatarPhoto = document.getElementById('avatarPhoto');
            const avatarInitial = document.getElementById('avatarInitial');
            
            if (profilePhoto) {
                avatarPhoto.src = profilePhoto;
                avatarPhoto.style.display = 'block';
                avatarInitial.style.display = 'none';
            } else {
                avatarPhoto.style.display = 'none';
                avatarInitial.style.display = 'flex';
                avatarInitial.textContent = initial;
            }
        }

        function loadPost() {
            fetch(`../backend/get_posts.php?id=${postId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.post) {
                        displayPost(data.post);
                    } else {
                        window.location.href = 'dashboard.html';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    window.location.href = 'dashboard.html';
                });
        }

        function displayPost(post) {
            const container = document.getElementById('postContainer');
            const isOwner = post.user_id == currentUserId;
            const profilePhoto = post.profile_photo || '';

            const html = `
                <div class="single-post-view">
                    <div class="post-header-single">
                        <div class="post-author-info-single">
                            <img src="${profilePhoto || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22 viewBox=%220 0 100 100%22%3E%3Ccircle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%2310b981%22/%3E%3Ctext x=%2250%22 y=%2258%22 font-size=%2245%22 fill=%22white%22 text-anchor=%22middle%22 font-family=%22Arial%22%3E${escapeHtml(post.username.charAt(0).toUpperCase())}%3C/text%3E%3C/svg%3E'}" 
                                 alt="${escapeHtml(post.username)}" 
                                 class="post-author-photo-large"
                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22 viewBox=%220 0 100 100%22%3E%3Ccircle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%2310b981%22/%3E%3Ctext x=%2250%22 y=%2258%22 font-size=%2245%22 fill=%22white%22 text-anchor=%22middle%22 font-family=%22Arial%22%3E${escapeHtml(post.username.charAt(0).toUpperCase())}%3C/text%3E%3C/svg%3E'">
                            <div>
                                <h4 class="post-author-name">${escapeHtml(post.username)}</h4>
                                <span class="post-date-single">${formatDate(post.created_at)}</span>
                            </div>
                        </div>
                        ${isOwner ? `
                            <div class="post-actions-single">
                                <a href="edit_post.html?id=${post.id}" class="btn btn-small">Edit</a>
                                <button onclick="deletePost(${post.id})" class="btn btn-small btn-danger">Delete</button>
                            </div>
                        ` : ''}
                    </div>

                    <h1 class="post-title-single">${escapeHtml(post.title)}</h1>

                    ${post.image ? `
                        <div class="post-image-single">
                            <img src="${post.image}" alt="${escapeHtml(post.title)}">
                        </div>
                    ` : ''}

                    <div class="post-content-single">
                        <p>${escapeHtml(post.content).replace(/\n/g, '<br>')}</p>
                    </div>

                    <div class="post-reactions-single">
                        <button onclick="reactToPost(${post.id}, 'like')" class="reaction-btn ${post.user_reaction === 'like' ? 'active' : ''}">
                            üëç ${post.likes || 0} Likes
                        </button>
                        <button onclick="reactToPost(${post.id}, 'dislike')" class="reaction-btn ${post.user_reaction === 'dislike' ? 'active' : ''}">
                            üëé ${post.dislikes || 0} Dislikes
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function reactToPost(postId, reaction) {
            const formData = new FormData();
            formData.append('post_id', postId);
            formData.append('reaction', reaction);
            
            fetch('../backend/react_handler.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadPost();
                }
            });
        }

        function deletePost(postId) {
            if (confirm('Are you sure you want to delete this post?')) {
                fetch('../backend/delete_post_handler.php?id=' + postId)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = 'dashboard.html';
                        } else {
                            alert(data.message);
                        }
                    });
            }
        }
    </script>
</body>
</html>
